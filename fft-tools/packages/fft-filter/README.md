# FFT Filter

## Overview

`fft-filter` applies frequency-domain filters to the complex FFT data generated by `fft-process`. This allows for scale-dependent modification of the terrain, such as removing high-frequency noise (low-pass filter) or removing large-scale trends (high-pass filter) before reconstruction.

The tool works directly on the complex spectrum (`.bin` files) and updates the metadata to reflect the applied filter.

## Features

- **Wavelength-Based Filtering:** Define cutoffs in physical units (meters), not abstract frequencies.
- **Filter Types:**
  - **Low-Pass:** Keep wavelengths *longer* than `min-wavelength` (removes small-scale roughness).
  - **High-Pass:** Keep wavelengths *shorter* than `max-wavelength` (removes large-scale terrain).
  - **Band-Pass:** Combine both to isolate a specific scale range.
- **Tapered Transitions:** Uses a cosine taper at the cutoff frequencies to prevent ringing artifacts (Gibbs phenomenon) in the spatial domain.
- **Metadata Update:** Automatically logs filter parameters in the block metadata for reproducibility.

## Usage

### Command Line Arguments

```bash
fft-filter [OPTIONS] --input <DIR> --output <DIR>
```

#### Required Arguments
- `--input <DIR>`: Directory containing `fft_complex_block_*.bin` files.
- `--output <DIR>`: Directory to save the filtered data.

#### Optional Arguments
- `--min-wavelength <METERS>`: Cutoff for Low-Pass filtering. Wavelengths SHORTER than this are attenuated (passes wavelengths LONGER than this).
- `--max-wavelength <METERS>`: Cutoff for High-Pass filtering. Wavelengths LONGER than this are attenuated (passes wavelengths SHORTER than this).
- `--taper-width <RATIO>`: Width of the transition band as a fraction of the cutoff frequency. Default is `0.5`.
- `--jobs <NUM>`: Number of parallel jobs to run. Defaults to 0 (all available cores).

### Example

Apply a band-pass filter to keep features between 50m and 500m in size:

```bash
fft-filter --input ./results/fft --output ./results/filtered \
    --min-wavelength 50 --max-wavelength 500
```

## Output

The tool replicates the file structure of the input directory in the output directory:

1.  **`fft_complex_block_*.bin`**: The filtered complex spectra.
2.  **`fft_metadata_block_*.json`**: Updated metadata files containing a new `filter` object in the `processing_params` section.

## Analyzing the Output

### Frequency-Domain Filtering
Filtering in the frequency domain is a "non-local" operation. Every spatial pixel is affected by the combination of all frequencies.
- **Isolating Landforms:** By using a band-pass filter, you can isolate specific geomorphic features (e.g., drumlins or dunes) based on their characteristic spacing.
- **Noise Removal:** Low-pass filtering (attenuating short wavelengths) effectively removes high-frequency white noise or "salt-and-pepper" artifacts common in photogrammetric DEMs.
- **Detrending vs. High-Pass:** While `fft-process` removes low-order polynomial trends, `fft-filter` with a high-pass setting removes *all* spectral power above a certain wavelength, providing a more rigorous scale-based decomposition.

### Ringing Artifacts (Gibbs Phenomenon)
Sharp cutoffs in the frequency domain produce "ripples" or ringing artifacts around sharp features in the spatial domain. 
- **Tapering:** To mitigate this, `fft-filter` uses a cosine taper (controlled by `--taper-width`). A larger taper width produces a smoother transition but results in a less precise cutoff in frequency space.
- **Check Reconstruction:** Always use `fft-inverse` to inspect the filtered terrain and ensure that the chosen filter parameters haven't introduced non-physical artifacts.
