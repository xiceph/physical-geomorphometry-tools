# FFT Process

## Overview

`fft-process` is the primary processing engine of the FFT DEM Analysis Toolkit. It is responsible for ingesting a Digital Elevation Model (DEM), decomposing it into manageable blocks, applying necessary pre-processing (detrending, windowing/tapering, padding), and computing the Fast Fourier Transform (FFT).

This tool solves the problem of analyzing large DEMs that do not fit into memory by processing them in overlapping blocks. It also handles the critical signal processing steps required to minimize edge effects and spectral leakage.

## Features

- **Block-Based Processing:** Automatically iterates over the DEM using a sliding window approach with configurable overlap.
- **Detrending:** Removes linear or planar trends (1st or 2nd order) from each block to focus on surface roughness.
- **Advanced Tapering:**
  - **Inner Tapering:** Standard Hann windowing applied to the data.
  - **Outer Tapering:** A specialized approach where a border is added *around* the data block and tapered to zero, preserving the signal within the analysis window.
- **Flexible Padding:** Supports minimum padding requirements or forced output sizes to ensure compatibility with specific FFT grid sizes.
- **Parallel Execution:** Utilizes multi-threading to process blocks concurrently.
- **Validation:** Performs checks for Parseval's theorem and DC component power to ensure the validity of the transform.

## Usage

### Command Line Arguments

```bash
fft-process [OPTIONS] --input <FILE> --output <DIR> --overlap <PIXELS>
```

#### Required Arguments
- `--input <FILE>`: Path to the input DEM (GeoTIFF).
- `--output <DIR>`: Directory where the output files will be saved.
- `--overlap <PIXELS>`: The size of the overlap between adjacent blocks in pixels.

#### Optional Arguments
- `--window-size <PIXELS>`: The size of the square processing block (N x N). If omitted, uses the smaller dimension of the input raster.
- `--detrend <ORDER>`: Apply polynomial detrending to each block. `1` for linear (planar), `2` for quadratic. If the flag is omitted, no detrending is performed. If the flag is provided without an order, it defaults to `1`.
- `--taper-type <TYPE>`: `inner` (standard window) or `outer` (tapered padding). Default is `outer`.
- `--taper <WIDTH>`: Width of the taper in pixels. Defaults to 1/10th of the window size.
- `--min-pad <PIXELS>`: Minimum padding to add to the block. Default is `0`.
- `--force-padding-size <SIZE>`: Force the final padded block to be exactly this size.
- `--jobs <NUM>`: Number of parallel jobs to run. Defaults to 0 (all available cores).
- `--save-intermediate`: Save the pre-processed (detrended/tapered) spatial blocks for debugging. Default is `false`.

### Example

Process a DEM with 512x512 blocks, 50% overlap, using outer tapering:

```bash
fft-process --input terrain.tif --output ./results/run1 \
    --window-size 512 --overlap 256 \
    --taper-type outer --taper 50 \
    --detrend 1
```

## Output

For each processed block, `fft-process` generates three files in the output directory:

1.  **`fft_complex_block_ROW_COL.bin`**: The raw complex output of the FFT.
    -   Format: Raw binary, sequence of `Complex<f64>` (16 bytes per value).
    -   Layout: Row-major, corresponding to the padded size.
2.  **`fft_psd_block_ROW_COL.tif`**: The Power Spectral Density (PSD).
    -   Format: GeoTIFF (32-bit float or 64-bit float).
    -   Content: Log-transformed power values for visualization.
3.  **`fft_metadata_block_ROW_COL.json`**: Metadata about the block.
    -   Contains: Original/padded sizes, geo-transform, processing parameters, detrending coefficients, and validation statistics.

## Analyzing the Output

### Power Spectral Density (PSD)
The PSD generated by `fft-process` represents the distribution of topographic variance (power) across different spatial frequencies. In the Cartesian output:
- **Center Pixel:** Represents the DC component (mean elevation after detrending). If detrending was successful, this should be near zero.
- **Radial Distance from Center:** Corresponds to spatial frequency. Pixels further from the center represent smaller landforms (shorter wavelengths/higher frequencies).
- **Direction from Center:** Corresponds to the orientation of landform features.

### Validation Statistics
- **Parseval's Theorem:** Validates that energy is conserved between the spatial and frequency domains. An error < 1e-6 indicates a mathematically sound transform.
- **DC Power Percentage:** A high value here indicates that a significant portion of the signal's energy is in the mean elevation, suggesting that detrending might be insufficient if the goal is to analyze surface roughness.
- **Residual Mean:** Should be near zero. It indicates the remaining average elevation after the polynomial trend has been removed.
